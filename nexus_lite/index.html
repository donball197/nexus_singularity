<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>NEXUS LITE</title>
<style>
:root { --c:#00ff9d; --b:#000; --p:#111; --err:#ff0055; }
body { margin:0; font-family:monospace; background:var(--b); color:#ccc; height:100vh; display:flex; flex-direction:column; overflow:hidden; }
#head { background:var(--p); padding:10px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center; }
.brand { color:var(--c); font-weight:bold; letter-spacing:1px; }
.stat { font-size:10px; color:#666; }
.view { flex:1; display:none; flex-direction:column; overflow:hidden; position:relative; }
.view.active { display:flex; }
#chat { flex:1; overflow-y:auto; padding:15px; scroll-behavior:smooth; }
.msg { margin-bottom:15px; border-left:2px solid #333; padding-left:10px; white-space:pre-wrap; font-size:14px; }
.msg.ai { border-color:var(--c); color:var(--c); }
.msg.user { border-color:#666; color:#fff; }
#controls { background:#080808; padding:8px; border-bottom:1px solid #333; display:flex; gap:5px; overflow-x:auto; }
select,input,button { background:#222; color:#fff; border:1px solid #444; padding:8px; font-family:monospace; font-size:12px; }
.del-btn { color:var(--err); border-color:var(--err); }
#ed { flex:1; background:#000; color:#ddd; border:none; padding:15px; outline:none; resize:none; font-family:monospace; font-size:14px; }
#foot { background:var(--p); border-top:1px solid #333; display:flex; flex-direction:column; }
#in-bar { padding:10px; display:flex; }
#prompt { flex:1; background:#000; border:1px solid #444; color:#fff; padding:12px; outline:none; font-family:monospace; }
#nav { display:flex; height:45px; border-top:1px solid #222; }
.btn { flex:1; background:transparent; border:none; color:#555; font-weight:bold; font-size:14px; }
.btn.active { color:var(--c); border-top:2px solid var(--c); background:#1a1a1a; }
</style>
</head>
<body>
<div id="head"><div class="brand">NEXUS LITE</div><div id="stat" class="stat">WAITING...</div></div>
<div id="v1" class="view active"><div id="chat"><div class="msg ai">SYSTEM ONLINE.</div></div></div>
<div id="v2" class="view">
    <div id="controls">
        <select id="fs" onchange="load()"><option value="">-- File --</option></select>
        <button onclick="fetchF()">â†»</button>
        <input id="nf" placeholder="new.txt" style="width:70px">
        <button onclick="mk()">NEW</button>
        <button onclick="sv()">SAVE</button>
        <button onclick="rm()" class="del-btn">DEL</button>
    </div>
    <textarea id="ed" placeholder="// Workspace empty..."></textarea>
</div>
<div id="foot">
    <div id="in-bar"><input id="prompt" placeholder="Command..." autocomplete="off"></div>
    <div id="nav">
        <button class="btn active" onclick="sw('v1',this)">CHAT</button>
        <button class="btn" onclick="sw('v2',this);fetchF()">FILES</button>
    </div>
</div>
<script>
const $ = i => document.getElementById(i);
function sw(v,b){
    document.querySelectorAll('.view').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.btn').forEach(x=>x.classList.remove('active'));
    $(v).classList.add('active'); b.classList.add('active');
}
async function fetchF(){
    try {
        const r = await fetch('/files');
        const f = await r.json();
        $('fs').innerHTML = '<option value="">-- File --</option>' + f.map(x=>`<option value="${x}">${x}</option>`).join('');
    } catch(e) {}
}
async function load(){
    const n = $('fs').value; if(!n) return;
    const r = await fetch('/workspace/'+n);
    $('ed').value = await r.text();
}
async function mk(){
    const n = $('nf').value; if(!n) return;
    await fetch('/create',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({filename:n})});
    fetchF(); $('nf').value='';
}
async function sv(){
    const p = $('fs').value; const c = $('ed').value;
    if(!p) return;
    const r = await fetch('/save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({path:p,content:c,force:true})});
    alert("Saved");
}
async function rm(){
    const n = $('fs').value; if(!n || !confirm('Delete '+n+'?')) return;
    await fetch('/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({filename:n})});
    fetchF(); $('ed').value='';
}
new EventSource('/monitor').onmessage = e => {
    const d = JSON.parse(e.data);
    $('stat').innerText = `CPU:${d.cpu} RAM:${d.ram}`;
}
$('prompt').onkeypress = async e => {
    if(e.key !== 'Enter') return;
    const t = $('prompt').value; $('prompt').value = ''; if(!t) return;
    const h = $('chat');
    const u = document.createElement('div'); u.className = 'msg user'; u.innerText = t; h.appendChild(u);
    const ai = document.createElement('div'); ai.className = 'msg ai'; h.appendChild(ai);
    h.scrollTop = h.scrollHeight;
    const r = await fetch('/ask', {method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({prompt:t})});
    const reader = r.body.getReader(); const dec = new TextDecoder();
    while(true){
        const {done, value} = await reader.read(); if(done) break;
        const ch = dec.decode(value, {stream:true});
        ch.split('\n').filter(l=>l.startsWith('data: ')).forEach(l=> ai.innerText += l.slice(6));
        h.scrollTop = h.scrollHeight;
    }
}
</script>
</body>
</html>
